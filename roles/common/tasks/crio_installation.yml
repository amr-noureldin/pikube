# Adding the crio repository and install
# Documentation at
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/
# https://github.com/cri-o/cri-o
# https://medium.com/@raghwendrasingh1819/diy-kubernetes-cluster-with-cri-o-container-runtime-ubuntu-xenial-53e967c33dd9

- name: Enable the overlay module
  become: true
  lineinfile: 
    path: /etc/modules-load.d/modules.conf
    line: 'overlay'
    state: present

- name: Load the overlay module
  become: true
  modprobe:
    name: overlay
    state: present

- name: Enable the br_netfilter module
  become: true
  lineinfile: 
    path: /etc/modules-load.d/modules.conf
    line: 'br_netfilter'
    state: present

- name: Load the br_netfilter module
  become: true
  modprobe:
    name: br_netfilter
    state: present

- name: 99-kubernetes-cri.conf 1
  become: true
  sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
    reload: yes

- name: 99-kubernetes-cri.conf 2
  become: true
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
    reload: yes

- name: 99-kubernetes-cri.conf 3
  become: true
  sysctl:
    name: net.bridge.bridge-nf-call-ip6tables
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
    reload: yes

- name: add crio apt-key for {{ os_used }} {{ os_version }}
  become: true
  apt_key:
    url: "https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/x{{ os_used }}_{{ os_version }}/Release.key"
    state: present

- name: add crio apt repository {{ os_used }} {{ os_version }}
  become: true
  apt_repository:
    repo: 'deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/x{{ os_used }}_{{ os_version }}/ /'
    state: present
    filename: devel:kubic:libcontainers:stable.list
    update_cache: yes

- name: install crio {{ crio_version }}
  become: true
  apt:
    name: cri-o-{{ crio_version }}
    state: present
    update_cache: yes

- name: install crio runc, podman and skopeo
  become: true
  apt:
    pkg:
    - cri-o-runc
    - cri-tools
    - podman
    - podman-plugins
    - skopeo
    - catatonit
    - fuse-overlayfs
    - conmon
    - containers-common
    - containers-golang
    - containers-image
    - containernetworking-plugins
    - libslirp0
    - slirp4netns
    - uidmap
    - varlink

# Fix for a known issue, probably not needed in the future
# https://github.com/cri-o/cri-o/issues/3504
#- name: replace line, Fix cri-o issue 3504
#  become: true
#  lineinfile: 
#    path: /etc/crio/crio.conf
#    regexp: 'apparmor_profile = "crio-default"' 
#    line: 'apparmor_profile = "crio-default-{{ crio_version }}.2"'
#    backrefs: yes # w/o this, the operation isn't idempotent'

- name: Point crio.conf towards CNI plugins
  become: true
  lineinfile: 
    path: /etc/crio/crio.conf
    regexp: '"/opt/cni/bin/",' 
    line: '"/opt/cni/bin/", "/usr/lib/cni/"'
    backrefs: yes # w/o this, the operation isn't idempotent'

- name: Enable CPU accounting
  become: true
  lineinfile: 
    path: /etc/systemd/system.conf
    regexp: '#DefaultCPUAccounting=no' 
    line: 'DefaultCPUAccounting=yes'
    backrefs: yes # w/o this, the operation isn't idempotent'

- name: Enable BlockIO accounting
  become: true
  lineinfile: 
    path: /etc/systemd/system.conf
    regexp: '#DefaultBlockIOAccounting=no' 
    line: 'DefaultBlockIOAccounting=yes'
    backrefs: yes # w/o this, the operation isn't idempotent'

- name: systemd reload
  become: true
  systemd:
    daemon_reload: yes

- name: enable crio
  become: true
  systemd:
    enabled: yes
    name: crio
    masked: no

- name: start crio
  become: true
  systemd:
    state: restarted
    name: crio
