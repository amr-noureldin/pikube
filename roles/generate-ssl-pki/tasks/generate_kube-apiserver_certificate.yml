# entry point for creating new SSL Cartificate Authority
# https://github.com/githubixx/ansible-role-kubernetes-ca
# https://github.com/mmumshad/kubernetes-the-hard-way/blob/master/docs/04-certificate-authority.md
- name: Create directory for certificates
  file:
    path: certificates
    state: directory

- name: Generate an OpenSSL 2048 bit private RSA key
  openssl_privatekey:
    path: "certificates/{{ cluster_name }}-kube-apiserver.key"
    size: 2048
    type: RSA

- name: Check if certificate authority exists
  stat:
    path: "certificates/{{ cluster_name }}-ca.key"
  register: ca_exists

- name: Check if kube-apiserver certificate exists
  stat:
    path: "certificates/{{ cluster_name }}-kube-apiserver.crt"
  register: kube_apiserver_cert_exists

- name: Generate an OpenSSL Certificate Signing Request
  openssl_csr:
    path: "certificates/{{ cluster_name }}-kube-apiserver.csr"
    privatekey_path: "certificates/{{ cluster_name }}-kube-apiserver.key"
    key_usage:
      - digitalSignature
      - nonRepudiation
      - keyAgreement
      - dataEncipherment
      - keyEncipherment
    extended_key_usage:
      - clientAuth
      - serverAuth
    subject: "CN=kube-apiserver/O=system:masters"
    subject_alt_name: "DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc,DNS:kubernetes.default.svc.cluster,DNS:kubernetes.default.svc.cluster.local,{{ masters_ips }},{{ masters_names }}"
  when: ca_exists.stat.exists == True and kube_apiserver_cert_exists.stat.exists == False

- name: Print the names of the master nodes
  debug:
    msg: Names {{ masters_names }}

- name: Sign the kube-apiserver key with CA to obtain kube-apiserver certificate
  openssl_certificate:
    path: "certificates/{{ cluster_name }}-kube-apiserver.crt"
    privatekey_path: "certificates/{{ cluster_name }}-ca.key"
    csr_path: "certificates/{{ cluster_name }}-kube-apiserver.csr"
    provider: selfsigned
  when: ca_exists.stat.exists == True and kube_apiserver_cert_exists.stat.exists == False

- name: Remove Certificate Signing Request
  file:
    path: "certificates/{{ cluster_name }}-kube-apiserver.csr"
    state: absent
